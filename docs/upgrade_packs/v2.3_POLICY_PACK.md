# ✅ v2.3 POLICY PACK (OPA-style)
# 1) POLICY_RULES.md Template + Baseline Rule Set (MVP)
# 2) run_policy_checks.ts Contract (How to read & enforce)

본 문서는 v2.3에서 Policy Rule Engine(OPA 스타일)을 적용하기 위한
(1) 정책 문서 템플릿/기본 룰셋(POLICY_RULES.md)
(2) 정책 검사 스크립트(run_policy_checks.ts)의 파일 기반 계약서
를 한 번에 제공합니다.

원칙:
- Policy는 “허용/차단”만 결정한다 (PASS/FAIL).
- Policy는 코드/로직에서 분리되어 문서로 관리된다.
- Policy는 Execute 전에 반드시 검사된다 (Gate).
- LLM은 “대안/수정”을 제안할 수 있지만, Policy 자체는 결정적이다.

⚠️ 코드블럭 안정성:
- 단일 코드블럭 문서
- 내부 예시는 `~~~`만 사용 (``` 사용 금지)

---

# 1) POLICY_RULES.md (v2.3 MVP)

## 1.1 파일 위치 (고정)
PROJECT_ROOT/
└── POLICY_RULES.md

---

## 1.2 문서 목적
- 프로젝트가 무엇을 하든, “절대 하면 안 되는 것”을 선언한다.
- orchestrator는 Execute 직전에 정책 검사를 강제한다.
- auditor는 정책 검사 결과와 정책 준수 여부를 재검증한다.

---

## 1.3 정책 평가 입력(Context)
Policy Engine은 아래 입력을 기준으로 평가한다.

- MASTER_PLAN.md (필수)
  - PLATFORM_MODE
  - PRIMARY_TYPE
  - LANGUAGE
  - BACKEND_REQUIRED
  - REPO_LAYOUT
- 현재 Phase (state.json의 current_phase)
- 코드베이스 스캔 대상 경로
  - apps/web
  - apps/mobile
  - shared/ (있을 경우)

---

## 1.4 정책 문서 포맷 (MVP 고정 스키마)

정책은 아래 “Rule Block”의 반복으로 구성한다.

~~~text
## RULE: <RULE_ID>
- Severity: [CRITICAL | MAJOR | MINOR]
- When:
  - (조건들)
- Must:
  - (필수 조건들)  # 선택
- MustNot:
  - (금지 조건들)  # 선택
- Scan:
  - Paths:
    - (스캔 경로)
  - Patterns:
    - (정규식 또는 키워드 패턴)
- Message:
  - (위반 시 리포트 메시지)
- Rationale:
  - (왜 필요한지)
~~~

MVP 제약:
- When / Must / MustNot은 “단순 비교 조건”만 허용한다.
- Patterns는 정규식 또는 키워드 목록으로 제한한다.
- AST 분석은 v2.4+에서 확장한다.

---

## 1.5 Baseline Rule Set (v2.3 MVP)

아래 룰셋은 “유니버설 오케스트레이션”에서 가장 자주 발생하는 사고를
사전에 차단하도록 설계된 최소 세트다.

### Rule Group A: Backend Flag Compliance
(서버 필요/불필요 플래그 위반 차단)

#### A1) BACKEND_REQUIRED=NO 인데 DB 클라이언트/ORM 금지
~~~text
## RULE: POLICY_DB_FORBIDDEN_WHEN_BACKEND_NO
- Severity: CRITICAL
- When:
  - BACKEND_REQUIRED == NO
- MustNot:
  - Any database client or ORM usage must exist
- Scan:
  - Paths:
    - apps/web
    - apps/mobile
    - shared
  - Patterns:
    - "\bpg\b"
    - "\bpostgres\b"
    - "\bprisma\b"
    - "\btypeorm\b"
    - "\bsequelize\b"
    - "\bsupabase\b"
    - "\bneon\b"
    - "\bmongodb\b"
    - "createPool"
    - "PrismaClient"
- Message:
  - "BACKEND_REQUIRED=NO but database client/ORM detected."
- Rationale:
  - "Backend-free 모드에서 DB 의존성은 설계 위반이며 운영/비용/복잡도를 급증시킨다."
~~~

#### A2) BACKEND_REQUIRED=NO 인데 서버 API 라우트/서버 프레임워크 금지
~~~text
## RULE: POLICY_SERVER_FORBIDDEN_WHEN_BACKEND_NO
- Severity: CRITICAL
- When:
  - BACKEND_REQUIRED == NO
- MustNot:
  - Any server runtime route/framework must exist
- Scan:
  - Paths:
    - apps/web
    - shared
  - Patterns:
    - "\bexpress\b"
    - "\bfastapi\b"
    - "\bnestjs\b"
    - "\bkoa\b"
    - "\bhono\b"
    - "\bserver\.ts\b"
    - "\bapi\/\b"
    - "\broute\.ts\b"
    - "\bcontrollers?\b"
- Message:
  - "BACKEND_REQUIRED=NO but server routes/framework detected."
- Rationale:
  - "Backend 불필요 조건에서 서버 구현은 요구사항 불일치(과잉 설계)다."
~~~

---

### Rule Group B: Platform Mode Coherence
(웹/앱 모드 불일치 차단)

#### B1) PLATFORM_MODE=WEB 인데 모바일 권한/센서/푸시 API 금지
~~~text
## RULE: POLICY_MOBILE_APIS_FORBIDDEN_WHEN_WEB
- Severity: MAJOR
- When:
  - PLATFORM_MODE == WEB
- MustNot:
  - Mobile permission/sensor/push APIs must exist
- Scan:
  - Paths:
    - apps/web
  - Patterns:
    - "\bandroid\b"
    - "\bios\b"
    - "\bpermission\b"
    - "\bgeolocation\b"
    - "\bcamera\b"
    - "\bbluetooth\b"
    - "\bpush\b"
    - "\bnotification\b"
    - "\bflutter\b"
    - "\breact-native\b"
- Message:
  - "PLATFORM_MODE=WEB but mobile APIs/keywords detected in web app."
- Rationale:
  - "Web-only 프로젝트에서 모바일 플랫폼 코드가 섞이면 유지보수와 빌드 파이프라인이 망가진다."
~~~

#### B2) PLATFORM_MODE=APP 인데 SEO 메타/서버 사이드 SEO 전략 금지(강제는 아님, 금지)
~~~text
## RULE: POLICY_SEO_FORBIDDEN_WHEN_APP_ONLY
- Severity: MINOR
- When:
  - PLATFORM_MODE == APP
- MustNot:
  - SEO-specific web metadata strategies must exist
- Scan:
  - Paths:
    - apps/mobile
    - shared
  - Patterns:
    - "\bmeta name=\"description\"\b"
    - "\bopen graph\b"
    - "\btwitter:card\b"
    - "\bSEO\b"
    - "\bsitemap\b"
    - "\brobots\.txt\b"
- Message:
  - "PLATFORM_MODE=APP but SEO/web metadata artifacts detected."
- Rationale:
  - "앱 단독 모드에서는 SEO가 핵심이 아니며 불필요한 아티팩트를 유입시킨다."
~~~

---

### Rule Group C: Repo Layout Guard
(구조 무결성 유지: APPS_SPLIT 강제)

#### C1) REPO_LAYOUT=APPS_SPLIT 인데 루트에 앱 코드 난립 금지
~~~text
## RULE: POLICY_APPS_SPLIT_LAYOUT_ENFORCED
- Severity: MAJOR
- When:
  - REPO_LAYOUT == APPS_SPLIT
- Must:
  - apps/web or apps/mobile directory must exist (according to PLATFORM_MODE)
- MustNot:
  - Root-level app source directories must exist
- Scan:
  - Paths:
    - .
  - Patterns:
    - "\bsrc\/pages\b"
    - "\blib\/main\.dart\b"
    - "\bandroid\/app\b"
    - "\bios\/Runner\b"
- Message:
  - "REPO_LAYOUT=APPS_SPLIT but app sources found outside apps/* structure."
- Rationale:
  - "구조가 흐트러지면 오케스트레이터의 계획/게이트/스냅샷이 무력화된다."
~~~

---

### Rule Group D: Plan & Gate Safety
(승인 없는 실행 우회 차단은 enforce_gates가 주 역할이지만, policy도 보조)

#### D1) Execute 전에 Plan 승인 누락이면 FAIL (policy 보조 규칙)
~~~text
## RULE: POLICY_PLAN_APPROVAL_REQUIRED_BEFORE_EXECUTE
- Severity: CRITICAL
- When:
  - MODE == EXECUTE
- Must:
  - APPROVAL_STATUS == APPROVED
- Scan:
  - Paths:
    - .orchestrator
  - Patterns:
    - "approval_status"
- Message:
  - "Execute mode attempted without APPROVED plan."
- Rationale:
  - "계획/승인 없는 실행은 자동화 사고의 최단 경로다."
~~~

Note:
- 이 규칙은 파일 스캔보다는 state.json 값을 읽는 방식으로 평가된다.
- Patterns 항목은 형식 유지를 위한 placeholder다.

---

## 1.6 룰 확장 가이드 (v2.4+)
- 정규식 스캔 → AST 기반(Typescript/Flutter)으로 확장
- “금지”뿐 아니라 “필수”(Must)도 정교화
- 예: BACKEND_REQUIRED=YES이면 DB 마이그레이션 파일 존재 필수

---

# 2) run_policy_checks.ts 계약서 (File-based Contract)

## 2.1 목적
- POLICY_RULES.md를 읽고,
  MASTER_PLAN/state 기반 Context를 구성한 다음,
  코드베이스를 스캔하여 정책 위반을 탐지한다.
- 결과를 .orchestrator/policy_report.json에 기록한다.
- PASS/FAIL은 Gate(enforce_gates)에 의해 실행 전 차단에 사용된다.

---

## 2.2 파일 위치(권장)
.agent/skills/orchestrator/scripts/run_policy_checks.ts

---

## 2.3 Inputs (읽기)

### Required
- POLICY_RULES.md
- MASTER_PLAN.md
- .orchestrator/state.json

### Optional
- apps/web (존재 시 스캔)
- apps/mobile (존재 시 스캔)
- shared (존재 시 스캔)

---

## 2.4 Context Construction Rules (중요)

run_policy_checks.ts는 아래 값을 Context로 구성한다.

### From MASTER_PLAN.md
- PLATFORM_MODE
- PRIMARY_TYPE
- LANGUAGE
- BACKEND_REQUIRED
- REPO_LAYOUT

### From state.json
- MODE (DRY_RUN/EXECUTE)
- APPROVAL_STATUS
- CURRENT_PHASE

Context Example (in-memory):
~~~json
{
  "PLATFORM_MODE": "HYBRID",
  "PRIMARY_TYPE": "NEXTJS",
  "LANGUAGE": "TypeScript",
  "BACKEND_REQUIRED": "NO",
  "REPO_LAYOUT": "APPS_SPLIT",
  "MODE": "DRY_RUN",
  "APPROVAL_STATUS": "PENDING",
  "CURRENT_PHASE": 0
}
~~~

---

## 2.5 POLICY_RULES.md Parsing (MVP)

MVP 파서는 아래만 지원한다.

- RULE 블록 구분: "## RULE: <ID>" 로 시작
- 필드:
  - Severity
  - When (조건들)
  - Must (조건들)
  - MustNot (조건들)
  - Scan.Paths
  - Scan.Patterns (정규식/키워드)
  - Message
  - Rationale

제약:
- 조건 표현은 오직 다음 형태만 허용:
  - KEY == VALUE
- KEY는 Context key와 일치해야 함
- VALUE는 문자열(대문자/숫자/언더스코어)

---

## 2.6 Evaluation Semantics (평가 의미)

각 RULE은 다음 순서로 평가한다.

1) When 조건 평가
- 모든 When 조건이 true면 Rule 활성화
- 하나라도 false면 Rule은 SKIP

2) Must 평가 (선택)
- Must는 “반드시 만족해야 하는 조건”
- 파일 존재 조건 또는 패턴 존재 조건으로 해석한다
- MVP에서는 Must는 다음 두 타입만 지원:
  - PATH_EXISTS: 특정 경로가 존재해야 함
  - PATTERN_EXISTS: 패턴이 최소 1회 매치되어야 함

3) MustNot 평가 (선택)
- MustNot은 “존재하면 안 되는 것”
- Scan 대상에서 패턴이 발견되면 위반

4) 위반 기록
- 위반이 1개라도 있으면 status=FAIL
- Severity=CRITICAL 위반이 있으면 즉시 FAIL 가능(early exit) (선택)

---

## 2.7 Scanning Rules (스캔 규칙)

### Paths
- Scan.Paths에 지정된 경로만 스캔한다.
- 경로가 없으면 skip 또는 violation (RULE에 따라 다름)

### Patterns
- Patterns는 문자열 리스트이며, 정규식으로 취급한다.
- 각 패턴 매치 시:
  - file path
  - line snippet(최대 120 chars)
  - rule_id
  - severity
  를 evidence로 기록한다.

### File Types (MVP)
- 텍스트 기반 소스만 스캔:
  - .ts .tsx .js .jsx .dart .kt .swift .md .json .yml .yaml .toml
- 바이너리/이미지/대용량 파일은 제외(>2MB)

---

## 2.8 Outputs (쓰기)

### Required
- .orchestrator/policy_report.json

### Optional (사람용)
- POLICY_REPORT.md (원하면 auditor가 생성해도 됨)

---

## 2.9 policy_report.json 스키마 (고정)

~~~json
{
  "generated_at": "2026-01-19T14:00:00+09:00",
  "status": "PASS",
  "rules_checked": 0,
  "rules_skipped": 0,
  "violations": [
    {
      "rule_id": "POLICY_DB_FORBIDDEN_WHEN_BACKEND_NO",
      "severity": "CRITICAL",
      "path": "apps/web/src/lib/db.ts",
      "evidence": "import { PrismaClient } from '@prisma/client'",
      "context": {
        "PLATFORM_MODE": "WEB",
        "BACKEND_REQUIRED": "NO",
        "MODE": "EXECUTE",
        "CURRENT_PHASE": 2
      }
    }
  ]
}
~~~

---

## 2.10 Exit Codes (고정)

- 0: PASS (위반 없음)
- 1: FAIL (위반 존재; 정상 동작)
- 2: ERROR (입력 누락/파싱 실패/권한 문제)

---

## 2.11 Orchestrator Gate Integration (연동 규칙)

orchestrator(enforce_gates)는 다음 규칙을 강제한다.

- run_policy_checks.ts exit=1 또는 policy_report.status=FAIL이면:
  - Execute 차단
  - Snapshot이 있으면 롤백
  - RUN_LOG에 위반 요약 기록

---

## 2.12 MVP 운영 팁

- 첫 도입 시 Rules는 “CRITICAL 최소”로 시작하고 점진 확대
- 규칙이 과하면 false positive로 생산성이 떨어진다
- Baseline(A1/A2/B1/C1/D1)만으로도 사고의 80% 차단 가능

---

# END OF v2.3 POLICY PACK
