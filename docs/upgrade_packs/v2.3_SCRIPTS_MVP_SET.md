# ✅ v2.3 SCRIPTS MVP SET (Minimal Viable Automation)
# + Script I/O Contracts (File-based APIs)

목표:
- v2.3에서 “자동 감지 → 영향 분석 → 계획 생성/게이트 → 스냅샷/복구 → 정책 검사”
  를 최소 스크립트 세트로 구현한다.
- LLM(spec_analyst/auditor/orchestrator)은 “판단/설명/리포트”를 담당한다.
- scripts는 “측정/검증/실행”을 담당한다.
- 모든 scripts는 **파일 기반 계약(File API)** 으로만 통신한다.
  (STDOUT은 요약 로그만 허용, 진짜 데이터는 파일로 기록)

⚠️ 코드블럭 안정성:
- 단일 코드블럭 문서
- 내부 예시는 `~~~`만 사용 (``` 사용 금지)

---

# 0) 폴더 배치 (권장)

PROJECT_ROOT/
├── .agent/
│   └── skills/
│       ├── orchestrator/
│       │   ├── SKILL.md
│       │   └── scripts/
│       │       ├── detect_changes.ts
│       │       ├── compute_impact.ts
│       │       ├── generate_plan_actions.ts
│       │       ├── enforce_gates.ts
│       │       ├── snapshot.ts
│       │       └── run_policy_checks.ts
│       ├── spec_analyst/
│       │   └── scripts/
│       │       ├── score_platform.ts
│       │       └── extract_evidence.ts
│       └── auditor/
│           └── scripts/
│               └── verify_integrity.ts
├── .orchestrator/
│   ├── state.json
│   ├── fingerprints.json
│   ├── plan_actions.json
│   ├── policy_report.json
│   └── snapshots/
└── docs/ ...

Note:
- MVP는 orchestrator/scripts 중심으로도 충분하지만,
  “점수 계산/근거 후보 추출” 2개는 spec_analyst 품질을 크게 올리므로 포함.

---

# 1) v2.3 Scripts MVP 선정 (최소 세트)

## A. Orchestrator Scripts (필수 6개)
1) detect_changes.ts
2) compute_impact.ts
3) generate_plan_actions.ts
4) enforce_gates.ts
5) snapshot.ts
6) run_policy_checks.ts

## B. Analyst Scripts (권장 2개)
7) score_platform.ts
8) extract_evidence.ts

## C. Auditor Scripts (권장 1개)
9) verify_integrity.ts

총 9개가 v2.3 MVP 세트.

---

# 2) 공통 파일 계약 (Global Contracts)

scripts는 아래 “공용 파일”을 읽고/쓴다.

## 2.1 State File
- Path: .orchestrator/state.json
- Purpose: 현재 Phase/모드/승인 상태/마지막 정상 스냅샷 등 런타임 상태 저장

### Schema (MVP)
~~~json
{
  "version": "2.3",
  "current_phase": 0,
  "mode": "DRY_RUN",
  "approval_status": "PENDING",
  "last_pass_snapshot": "S1",
  "last_change_detected_at": "2026-01-19T13:10:00+09:00",
  "hashes": {
    "docs_prd": "prd:91ab77",
    "docs_design": "none",
    "docs_trd": "none",
    "master_plan": "mp:bb11a2",
    "decision_log": "dl:33aa00",
    "plan_output": "plan:77cc12"
  }
}
~~~

## 2.2 Fingerprints File
- Path: .orchestrator/fingerprints.json
- Purpose: 파일 해시/mtime/size 등 변경 감지를 위한 스냅샷 데이터

### Schema (MVP)
~~~json
{
  "generated_at": "2026-01-19T13:10:00+09:00",
  "files": {
    "docs/PRD.md": {"hash":"sha256:...", "mtime": 1737251400, "size": 12345},
    "docs/DESIGN.md": {"hash":"missing", "mtime": 0, "size": 0},
    "docs/TRD.md": {"hash":"missing", "mtime": 0, "size": 0},
    "MASTER_PLAN.md": {"hash":"sha256:...", "mtime": 1737251410, "size": 2222},
    "DECISION_LOG.md": {"hash":"sha256:...", "mtime": 1737251420, "size": 3333},
    "PLAN_OUTPUT.md": {"hash":"sha256:...", "mtime": 1737251430, "size": 4444}
  }
}
~~~

## 2.3 Plan Actions File
- Path: .orchestrator/plan_actions.json
- Purpose: “실행될 액션 목록(기계 실행용)”을 저장. LLM의 PLAN_OUTPUT.md는 이를 설명용으로 렌더링.

### Schema (MVP)
~~~json
{
  "generated_at": "2026-01-19T13:12:00+09:00",
  "based_on": {
    "master_plan_hash": "sha256:...",
    "decision_log_hash": "sha256:..."
  },
  "actions": [
    {"type":"CREATE_DIR", "path":"apps/web", "reason":"PRIMARY_TYPE=NEXTJS"},
    {"type":"WRITE_FILE", "path":"PLAN_OUTPUT.md", "reason":"Dry-run plan render"},
    {"type":"SKIP", "path":"apps/mobile", "reason":"web-first scope"}
  ]
}
~~~

## 2.4 Policy Report File
- Path: .orchestrator/policy_report.json
- Purpose: 정책 위반 검출 결과를 저장 (Auditor와 Gate에서 사용)

### Schema (MVP)
~~~json
{
  "generated_at": "2026-01-19T13:20:00+09:00",
  "status": "PASS",
  "rules_checked": 12,
  "violations": []
}
~~~

## 2.5 Snapshot Storage
- Path: .orchestrator/snapshots/<SNAP_ID>/
- Purpose: 파일/상태 스냅샷 저장 (압축 파일 또는 디렉토리)

권장 포함:
- docs/*
- MASTER_PLAN.md
- DECISION_LOG.md
- PLAN_OUTPUT.md
- .orchestrator/state.json
- .orchestrator/fingerprints.json
- (선택) apps/web, apps/mobile

---

# 3) Script-by-Script Contracts (입력/출력)

아래는 각 스크립트의 “파일 기반 I/O 계약서”다.

---

## 3.1 detect_changes.ts (필수)
### Purpose
- 핵심 문서/계약 파일들의 변경 여부를 기계적으로 감지
- fingerprints.json 갱신 및 change_event.json 생성(옵션)

### Inputs
- .orchestrator/fingerprints.json (이전 상태; 없으면 bootstrap)
- files:
  - docs/PRD.md, docs/DESIGN.md, docs/TRD.md
  - MASTER_PLAN.md, DECISION_LOG.md, PLAN_OUTPUT.md

### Outputs
- .orchestrator/fingerprints.json (현재 상태로 갱신)
- .orchestrator/change_event.json (변경 목록; 없으면 "no_change")

### Output Schema
~~~json
{
  "generated_at": "2026-01-19T13:10:00+09:00",
  "changed": [
    {"path":"docs/PRD.md","prev_hash":"sha256:...","curr_hash":"sha256:...","type":"MODIFIED"}
  ],
  "missing": ["docs/DESIGN.md","docs/TRD.md"],
  "no_change": false
}
~~~

### Exit Codes
- 0: 성공(변경 없음 또는 있음)
- 2: 치명적 오류(권한/경로/읽기 실패)

---

## 3.2 compute_impact.ts (필수)
### Purpose
- change_event.json + 규칙 테이블로 “영향 Phase/필수 재실행 시작점” 계산

### Inputs
- .orchestrator/change_event.json
- .orchestrator/state.json (현재 phase/mode)
- (선택) MASTER_PLAN.md hash (근거용)

### Outputs
- CHANGE_IMPACT_REPORT.md (사람/LLM용)
- .orchestrator/impact.json (기계용)

### impact.json Schema
~~~json
{
  "generated_at": "2026-01-19T13:11:00+09:00",
  "impacted_phases": {"0": true, "1": true, "2": true, "3": true},
  "recommended_start_phase": 0,
  "requires_plan_rerun": true,
  "requires_approval": true,
  "reasons": [
    {"phase":0,"reason":"PRD changed: platform detection may change"},
    {"phase":1,"reason":"Scaffold may change due to flags"}
  ]
}
~~~

### Exit Codes
- 0: 성공
- 2: 치명적 오류(입력 없음/파싱 실패)

---

## 3.3 generate_plan_actions.ts (필수)
### Purpose
- MASTER_PLAN.md + DECISION_LOG.md + impact.json을 읽고
  “기계 실행 가능한 액션 목록(plan_actions.json)” 생성
- LLM은 plan_actions.json을 바탕으로 PLAN_OUTPUT.md(설명)를 렌더

### Inputs
- MASTER_PLAN.md
- DECISION_LOG.md
- .orchestrator/impact.json
- .orchestrator/state.json

### Outputs
- .orchestrator/plan_actions.json

### Exit Codes
- 0: 성공
- 2: 치명적 오류(필수 입력 없음)

---

## 3.4 enforce_gates.ts (필수)
### Purpose
- Plan Gate + Impact Gate + Policy Gate를 강제로 적용
- “진입 가능한 phase/mode”를 state.json에 반영
- 우회 시도를 차단(Exit code)

### Inputs
- .orchestrator/state.json
- .orchestrator/impact.json (있으면 영향 분석 완료 여부)
- PLAN_OUTPUT.md (Approval.Status 확인) 또는 plan_actions.json 기반 승인 상태
- .orchestrator/policy_report.json

### Outputs
- .orchestrator/state.json (업데이트)
- .orchestrator/gate_result.json

### gate_result.json Schema
~~~json
{
  "generated_at": "2026-01-19T13:13:00+09:00",
  "gates": {
    "impact_report_present": true,
    "plan_output_present": true,
    "approval_approved": false,
    "policy_pass": true
  },
  "allowed": false,
  "block_reason": "Approval.Status is not APPROVED"
}
~~~

### Exit Codes
- 0: 통과(allowed=true)
- 1: 차단(allowed=false; 정상 차단)
- 2: 치명적 오류

---

## 3.5 snapshot.ts (필수)
### Purpose
- Phase 완료 시 스냅샷 생성
- Audit FAIL 시 마지막 PASS 스냅샷으로 복구

### Inputs
- .orchestrator/state.json (phase, last_pass_snapshot)
- .orchestrator/fingerprints.json
- (필수) 스냅샷 대상 파일/폴더 목록(내부 default list)

### Outputs
- .orchestrator/snapshots/<ID>/... (실제 스냅샷)
- SNAPSHOT_LOG.md (사람/LLM용)
- .orchestrator/state.json (RESTORED 시 업데이트)

### Operations
- create: snapshot.ts create --id S1 --phase 1
- restore: snapshot.ts restore --id S1

### Exit Codes
- 0: 성공
- 2: 치명적 오류(스냅샷 없음/권한 문제)

---

## 3.6 run_policy_checks.ts (필수)
### Purpose
- MASTER_PLAN 기반 정책을 코드베이스/파일에 적용해 위반을 기계적으로 탐지
- (정규식 기반 MVP) → 향후 AST 확장

### Inputs
- MASTER_PLAN.md (특히 BACKEND_REQUIRED, PLATFORM_MODE)
- 대상 폴더:
  - apps/web, apps/mobile (존재할 때)
- (선택) POLICY_RULES.md (v2.4+), MVP는 내장 룰셋

### Outputs
- .orchestrator/policy_report.json
- (선택) POLICY_REPORT.md (사람용 렌더; auditor가 생성해도 됨)

### Example Violations Schema
~~~json
{
  "generated_at": "2026-01-19T13:20:00+09:00",
  "status": "FAIL",
  "rules_checked": 12,
  "violations": [
    {
      "rule_id": "POLICY_DB_FORBIDDEN_WHEN_BACKEND_NO",
      "severity": "CRITICAL",
      "path": "apps/web/src/lib/db.ts",
      "evidence": "import { Client } from 'pg'"
    }
  ]
}
~~~

### Exit Codes
- 0: PASS
- 1: FAIL (위반 발견; 정상)
- 2: 치명적 오류

---

## 3.7 score_platform.ts (권장)
### Purpose
- PRD에서 키워드를 추출해 WEB_SCORE/APP_SCORE 계산
- LLM의 최종 판단을 돕는 “측정값” 생산

### Inputs
- docs/PRD.md

### Outputs
- .orchestrator/platform_score.json

### Schema
~~~json
{
  "generated_at": "2026-01-19T13:05:00+09:00",
  "web_score": 2,
  "app_score": 2,
  "hits": {
    "web": ["admin","dashboard"],
    "app": ["mobile"]
  }
}
~~~

---

## 3.8 extract_evidence.ts (권장)
### Purpose
- PRD/TRD/DESIGN에서 “근거 후보 문장”을 추출해 evidence 후보를 제공
- Decision Ledger 품질을 안정화

### Inputs
- docs/PRD.md
- docs/DESIGN.md (optional)
- docs/TRD.md (optional)

### Outputs
- .orchestrator/evidence_candidates.json

### Schema
~~~json
{
  "generated_at": "2026-01-19T13:06:00+09:00",
  "candidates": [
    {"source":"PRD","snippet":"관리자 화면에서 전체 콘텐츠 모니터링","tag":"WEB_HINT"},
    {"source":"PRD","snippet":"모바일에서도 쓰고 싶다","tag":"APP_HINT"}
  ]
}
~~~

---

## 3.9 verify_integrity.ts (권장)
### Purpose
- Decision/Plan/Impact/Snapshot 문서 간 정합성을 기계적으로 검사
- auditor의 PASS/FAIL 근거를 강화

### Inputs
- MASTER_PLAN.md
- DECISION_LOG.md
- PLAN_OUTPUT.md
- CHANGE_IMPACT_REPORT.md (optional)
- SNAPSHOT_LOG.md (optional)
- .orchestrator/state.json

### Outputs
- .orchestrator/integrity_report.json

### Schema
~~~json
{
  "generated_at": "2026-01-19T13:30:00+09:00",
  "status": "PASS",
  "checks": [
    {"id":"DECISION_COVERAGE","status":"PASS","details":"All core fields covered"},
    {"id":"PLAN_APPROVAL","status":"PASS","details":"APPROVED"},
    {"id":"IMPACT_PRESENT_IF_CHANGED","status":"PASS","details":"OK"}
  ]
}
~~~

### Exit Codes
- 0: PASS
- 1: FAIL (정합성 문제 발견; 정상)
- 2: 치명적 오류

---

# 4) 최소 실행 파이프라인 (MVP Run Order)

아래 순서로 호출하면 v2.3 자동화의 “핵심 루프”가 성립한다.

1) detect_changes.ts
2) compute_impact.ts   (no_change면 생략 가능)
3) score_platform.ts / extract_evidence.ts (선택; analyst 보조)
4) (LLM) spec_analyst: MASTER_PLAN/DECISION_LOG 갱신 (필요 시 Q&A)
5) generate_plan_actions.ts
6) (LLM) orchestrator: PLAN_OUTPUT.md 렌더 + Approval 수집
7) run_policy_checks.ts
8) enforce_gates.ts  (차단이면 종료/승인 대기)
9) (Execute) Phase 진행
10) snapshot.ts create (Phase 종료 시)
11) (Audit FAIL) snapshot.ts restore + 부분 재실행

---

# 5) MVP 성공 기준 (Definition of Done)

- 변경 감지 자동화(detect_changes)로 docs 변경이 잡힌다.
- 영향 분석(compute_impact)이 최소 재실행 시작점을 낸다.
- plan_actions 생성 → PLAN_OUTPUT 승인 게이트가 우회 불가능하다.
- 정책 검사(run_policy_checks)로 치명 위반을 차단한다.
- 스냅샷 생성/복구(snapshot)로 FAIL 후 안정 복귀한다.
- 정합성 검사(verify_integrity)가 PASS/FAIL 근거를 제공한다.

---

# END OF v2.3 SCRIPTS MVP + CONTRACTS
