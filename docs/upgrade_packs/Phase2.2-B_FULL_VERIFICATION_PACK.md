# ✅ Phase 2.2-B FULL VERIFICATION PACK
# Change Impact Analysis + Auto-Rollback Snapshot (End-to-End)

본 문서는 Universal Orchestration System v2.2-B의
핵심 기능을 **즉시 적용 + 검증 가능한 상태**로 정리한 통합 패키지입니다.

포함:
1) CHANGE_IMPACT_REPORT.md 템플릿/규칙/예시
2) SNAPSHOT_LOG.md 템플릿/규칙/예시
3) orchestrator SKILL.md 패치 (Impact Gate + Rollback Rule)
4) auditor SKILL.md 패치 (Impact/Snapshot 정합성 검사)
5) Phase 2.2-B 전체 실행 시뮬레이션 로그 (문서 변경 → 영향 분석 → 부분 재실행 → FAIL 롤백)

⚠️ 코드블럭 깨짐 방지:
- 단일 코드블럭 문서
- 내부 예시는 `~~~`만 사용 (``` 사용 금지)

---

# 0) 파일 위치(고정)

PROJECT_ROOT/
- CHANGE_IMPACT_REPORT.md
- SNAPSHOT_LOG.md
- (기존) DECISION_LOG.md
- (기존) PLAN_OUTPUT.md
- (기존) MASTER_PLAN.md
- (기존) RUN_LOG.md
- (기존) AUDIT_REPORT.md

---

# 1) CHANGE_IMPACT_REPORT.md (템플릿 + 규칙)

## 1.1 목적
문서/결정/계획이 변경될 때,
“어디부터 다시 실행해야 하는지”를 자동 계산해
불필요한 전체 재실행을 방지합니다.

Terraform plan diff / Bazel graph 사고방식 참고:
- 변경 → 영향 범위 계산 → 최소 단위 재실행

---

## 1.2 생성 시점(필수)
orchestrator는 아래 중 하나라도 발생하면 보고서를 생성해야 합니다.
- docs/PRD.md 변경
- docs/DESIGN.md 변경
- docs/TRD.md 변경
- MASTER_PLAN.md 변경
- DECISION_LOG.md 변경(결정 추가/수정)
- PLAN_OUTPUT.md 변경(Plan 수정/재승인)

---

## 1.3 무효화(Invalidate) 규칙(고정)

### A) 입력 문서 변경 → 영향을 받는 Phase
- PRD 변경:
  - Phase 0 (재분석/재판별)
  - Phase 2/3 (기능 구현/검증 영향 가능)
- DESIGN 변경:
  - Phase 2/3 (UI/UX 영향)
  - Phase 0은 일반적으로 영향 없음(단, 플랫폼 전제가 바뀌면 Phase 0 포함)
- TRD 변경:
  - Phase 0 (MASTER_PLAN 재작성 필요 가능)
  - Phase 1/2 (스캐폴딩/구현 영향)

### B) 계약/결정 문서 변경
- MASTER_PLAN 변경:
  - 최소 Phase 1부터(스캐폴딩/구조/스택 변경 가능)
  - 플랫폼/백엔드 플래그 변경이면 Phase 0까지 포함
- DECISION_LOG 변경:
  - 해당 Decision이 핵심 필드(PLATFORM/BACKEND/REPO_LAYOUT)면 Phase 0 포함
  - Tooling/Style 수준이면 Phase 1~2 수준

### C) Plan 문서 변경
- PLAN_OUTPUT 변경:
  - 기본 Phase 1 전 Gate 재승인 필요
  - Approval 재확인 필수

---

## 1.4 보고서 템플릿(고정)

~~~markdown
# Change Impact Report

## Metadata
- Generated By: orchestrator
- Timestamp: YYYY-MM-DD HH:MM
- Change Detection Method: [MANUAL | HASH | TIMESTAMP]

---

## Changed Inputs
- File:
  - Previous Fingerprint:
  - Current Fingerprint:
  - Change Summary:

(변경 파일 수만큼 반복)

---

## Impacted Decisions
- Decision Name:
- Reason:

---

## Impacted Phases
- Phase 0: [YES | NO] - Reason:
- Phase 1: [YES | NO] - Reason:
- Phase 2: [YES | NO] - Reason:
- Phase 3: [YES | NO] - Reason:

---

## Required Actions (Minimal Re-run Plan)
- Must Re-run:
  - Phase:
  - Owner Agent:
  - Notes:

---

## Gate Requirements
- Plan Mode Required: [YES | NO]
- Approval Required: [YES | NO] (if plan changed)

---

## Final Recommendation
- Start From Phase: [0 | 1 | 2 | 3]
- Safety Notes:
~~~

---

## 1.5 예시 (PRD 일부 변경 → Phase 0 재실행)

~~~markdown
# Change Impact Report

## Metadata
- Generated By: orchestrator
- Timestamp: 2026-01-19 12:10
- Change Detection Method: HASH

## Changed Inputs
- File: docs/PRD.md
  - Previous Fingerprint: prd:8f12a3
  - Current Fingerprint: prd:91ab77
  - Change Summary: "오프라인 사용 필요" 문구 추가

## Impacted Decisions
- Decision Name: PLATFORM_MODE
  - Reason: Offline requirement may shift toward APP/HYBRID
- Decision Name: BACKEND_REQUIRED
  - Reason: Offline sync strategy may require backend later

## Impacted Phases
- Phase 0: YES - platform detection & flags may change
- Phase 1: YES - scaffold may change (mobile app / storage libs)
- Phase 2: YES - offline handling implementation changes
- Phase 3: YES - UX states for offline

## Required Actions (Minimal Re-run Plan)
- Must Re-run:
  - Phase: 0
  - Owner Agent: @Agent_Analyst
  - Notes: Re-score + Gap Q&A update + MASTER_PLAN regen

## Gate Requirements
- Plan Mode Required: YES
- Approval Required: YES

## Final Recommendation
- Start From Phase: 0
- Safety Notes:
  - Stop execution if PLATFORM_MODE changes
~~~

---

# 2) SNAPSHOT_LOG.md (템플릿 + 규칙)

## 2.1 목적
Phase 완료 시점에 “정상 상태”를 기록하고,
FAIL 발생 시 마지막 정상 스냅샷으로 안전하게 복귀합니다.

Argo CD / CI rollback 사고방식:
- 실패하면 마지막 GREEN으로 회귀

---

## 2.2 생성 규칙(고정)
orchestrator는 Phase 종료 시 반드시 스냅샷을 생성합니다.

- Snapshot S0: Phase 0 완료 직후
- Snapshot S1: Phase 1 완료 직후
- Snapshot S2: Phase 2 기능 단위 완료 시(선택, 권장)
- Snapshot S3: Phase 3 PASS 직후(최종)

---

## 2.3 롤백 규칙(고정)

- Audit FAIL 발생 시:
  - 마지막 PASS 스냅샷으로 롤백
  - 롤백 사실을 RUN_LOG.md에 기록
  - 해당 Phase부터 재실행(Impact Report 참고)
- 스냅샷이 없으면:
  - 즉시 중단 + 사용자 보고 (심각)

---

## 2.4 스냅샷 기록 템플릿(고정)

~~~markdown
# Snapshot Log

## Snapshot: <ID>
- Phase: [0 | 1 | 2 | 3]
- Status: [CREATED | RESTORED]
- Timestamp: YYYY-MM-DD HH:MM
- Fingerprints:
  - docs/PRD.md:
  - docs/DESIGN.md:
  - docs/TRD.md:
  - MASTER_PLAN.md:
  - DECISION_LOG.md:
  - PLAN_OUTPUT.md:
- Notes:
- Restored Because: (RESTORED인 경우만)
~~~

---

## 2.5 예시 (S1 생성, FAIL 후 S1 복구)

~~~markdown
## Snapshot: S1
- Phase: 1
- Status: CREATED
- Timestamp: 2026-01-19 12:40
- Fingerprints:
  - docs/PRD.md: prd:91ab77
  - MASTER_PLAN.md: mp:aa33f0
  - PLAN_OUTPUT.md: plan:77cc12
- Notes: Web scaffold complete

## Snapshot: S1
- Phase: 1
- Status: RESTORED
- Timestamp: 2026-01-19 13:05
- Fingerprints:
  - docs/PRD.md: prd:91ab77
  - MASTER_PLAN.md: mp:aa33f0
  - PLAN_OUTPUT.md: plan:77cc12
- Notes: Rollback to last PASS state
- Restored Because: Phase 2 audit failed (policy violation)
~~~

---

# 3) orchestrator SKILL.md 패치 (Impact Gate + Rollback)

## 3.1 적용 위치
`.agent/skills/orchestrator/SKILL.md`

권장 위치:
- Phase 0~3 정의 이후, 별도 섹션 “Guards & Recovery”
- 또는 Phase 0 시작 전에 “Preflight / Change Detection”

---

## 3.2 추가 규칙(필수)

~~~markdown
## Change Impact Gate (v2.2-B)

- 입력 문서(docs/*) 또는 계약 문서(MASTER_PLAN/DECISION_LOG/PLAN_OUTPUT)가 변경되면,
  반드시 CHANGE_IMPACT_REPORT.md를 생성해야 한다.
- 영향 분석 결과가 나오기 전에는:
  - 다음 Phase로 진행 ❌ (차단)
- CHANGE_IMPACT_REPORT.md의 Final Recommendation에 따라
  - 최소 Phase부터 재실행한다.

## Snapshot & Rollback (v2.2-B)

- Phase 종료 시 SNAPSHOT_LOG.md에 스냅샷을 생성한다.
- Audit FAIL 발생 시:
  - 마지막 PASS 스냅샷으로 롤백한다.
  - 롤백 사실과 사유를 RUN_LOG.md에 기록한다.
  - CHANGE_IMPACT_REPORT.md에 따라 최소 Phase부터 재실행한다.
- 스냅샷이 없으면:
  - 즉시 중단 + 사용자 보고
~~~

---

# 4) auditor SKILL.md 패치 (Impact/Snapshot 정합성 검사)

## 4.1 적용 위치
`.agent/skills/auditor/SKILL.md`

권장 위치:
- Decision & Plan Integrity Check 섹션 다음

---

## 4.2 추가 검사 규칙(필수)

~~~markdown
## Impact & Snapshot Integrity Check (v2.2-B)

Auditor는 다음을 반드시 검사한다.

1) Change Impact Report Integrity
- 변경이 있었는데(입력 문서/MASTER_PLAN/DECISION_LOG/PLAN_OUTPUT),
  CHANGE_IMPACT_REPORT.md가 없으면 FAIL
- CHANGE_IMPACT_REPORT.md의 Impacted Phases/Required Actions가
  실제 재실행 흐름과 일치해야 한다.

2) Snapshot Log Integrity
- Phase 완료 시 SNAPSHOT_LOG.md에 스냅샷이 존재해야 한다.
- Audit FAIL 이후 롤백이 발생했다면,
  SNAPSHOT_LOG.md에 RESTORED 기록이 있어야 한다.

3) Consistency
- SNAPSHOT_LOG.md의 fingerprint는
  MASTER_PLAN/DECISION_LOG/PLAN_OUTPUT와 논리적으로 일치해야 한다.
~~~

---

# 5) Phase 2.2-B End-to-End 시뮬레이션 로그
## "문서 변경 → 영향 분석 → 최소 재실행 → FAIL 롤백" 전체 검증

---

## 5.1 시나리오 개요

- 초기 상태: v2.2-A까지 완료(Decision Ledger + Plan Gate 정상)
- 변경 이벤트: docs/PRD.md에 “오프라인 사용 필요” 추가
- 기대 동작:
  1) Change Impact Report 생성
  2) Phase 0부터 최소 재실행(플랫폼 재판정 가능)
  3) Plan Mode 재생성 및 승인 Gate 재통과
  4) Phase 2 진행 중 정책 위반으로 FAIL 발생
  5) Snapshot 롤백 후 재시도

---

## 5.2 변경 발생 (PRD 업데이트)

- Changed: docs/PRD.md
- Change: "오프라인에서도 핵심 기능 사용 가능" 추가

RUN_LOG 기록:

~~~markdown
## Event
- TYPE: DOC_CHANGE
- FILE: docs/PRD.md
- SUMMARY: Offline requirement added
~~~

---

## 5.3 Change Impact Analysis 실행

orchestrator는 Gate에 의해 즉시 영향 분석을 수행하고,
보고서를 생성해야 함.

생성 산출물: CHANGE_IMPACT_REPORT.md

(요약)

~~~markdown
## Impacted Phases
- Phase 0: YES - platform detection may change
- Phase 1: YES - scaffold changes possible
- Phase 2: YES - offline flows required
- Phase 3: YES - UI offline states
## Final Recommendation
- Start From Phase: 0
~~~

Gate 확인:
- 영향 분석 완료 전 다음 Phase 진행 ❌
- 보고서 생성 후 Phase 0 재실행 ⭕

RUN_LOG:

~~~markdown
## Gate
- CHANGE_IMPACT_REPORT: GENERATED
- ACTION: Re-run from Phase 0
~~~

---

## 5.4 Phase 0 재실행 (재판별 + Q&A 가능)

spec_analyst 재수행:
- Offline requirement는 APP/HYBRID 성격 가중

결정 변경 가능성:
- 이전: HYBRID
- 재평가: HYBRID 유지 또는 APP로 이동 가능

이 시뮬레이션에서는 “HYBRID 유지”로 가정

DECISION_LOG.md에 결정 재기록(추가 entry):

~~~markdown
## Decision: PLATFORM_MODE (Re-evaluated)
- Category: Platform
- Options Considered: WEB, APP, HYBRID
- Evidence:
  - PRD: Offline requirement added
  - Q&A: unchanged
- Default Applied: NO
- Final Decision: HYBRID
- Decided By: spec_analyst
~~~

Snapshot S0 생성(Phase 0 완료):

~~~markdown
## Snapshot: S0
- Phase: 0
- Status: CREATED
- Timestamp: 2026-01-19 12:20
- Fingerprints:
  - docs/PRD.md: prd:91ab77
  - MASTER_PLAN.md: mp:bb11a2
  - DECISION_LOG.md: dl:33aa00
  - PLAN_OUTPUT.md: plan:old
- Notes: Phase 0 re-run complete after PRD change
~~~

---

## 5.5 Plan Mode 재생성 + 승인 Gate

Phase 1 진입 전:
- PLAN_OUTPUT.md를 새로 생성해야 함 (계약 변경됨)

PLAN_OUTPUT.md (요약):

~~~markdown
## Summary
- Create: apps/web (adjust offline UI states)
- Modify: apps/web storage layer
- Skip: apps/mobile (still web-first)
## Approval
- Status: PENDING
~~~

Gate 상태:
- Approval PENDING → Phase 1 진입 ❌

승인 후:

~~~markdown
## Approval
- Status: APPROVED
- Approved By: User
~~~

Phase 1 진입 ⭕

Snapshot S1 생성(Phase 1 완료):

~~~markdown
## Snapshot: S1
- Phase: 1
- Status: CREATED
- Timestamp: 2026-01-19 12:45
- Fingerprints:
  - docs/PRD.md: prd:91ab77
  - MASTER_PLAN.md: mp:bb11a2
  - DECISION_LOG.md: dl:33aa00
  - PLAN_OUTPUT.md: plan:77cc12
- Notes: Updated scaffold + offline placeholders
~~~

---

## 5.6 Phase 2 진행 중 FAIL 발생(정책 위반 예시)

가정: Dev가 BACKEND_REQUIRED=NO인데 DB 연결 코드를 추가함(정책 위반)
Auditor 체크에서 FAIL

AUDIT_REPORT.md (요약):

~~~markdown
## Critical Issues
- Policy violation: BACKEND_REQUIRED=NO but database client introduced

## Final Verdict
STATUS: FAIL
~~~

---

## 5.7 롤백 트리거 (Auto-Rollback)

orchestrator 규칙:
- Audit FAIL → 마지막 PASS 스냅샷으로 롤백

마지막 PASS는 S1로 가정
SNAPSHOT_LOG.md에 RESTORED 기록:

~~~markdown
## Snapshot: S1
- Phase: 1
- Status: RESTORED
- Timestamp: 2026-01-19 13:05
- Fingerprints:
  - docs/PRD.md: prd:91ab77
  - MASTER_PLAN.md: mp:bb11a2
  - DECISION_LOG.md: dl:33aa00
  - PLAN_OUTPUT.md: plan:77cc12
- Notes: Rollback to last PASS state
- Restored Because: Phase 2 audit failed (policy violation)
~~~

RUN_LOG 기록:

~~~markdown
## Rollback
- FROM: Phase 2
- TO_SNAPSHOT: S1
- REASON: Audit FAIL
- NEXT_ACTION: Re-run Phase 2 only
~~~

---

## 5.8 최소 재실행 (Partial Re-run)

CHANGE_IMPACT_REPORT.md 기준:
- 변경 원인은 PRD 반영이었으나 이미 Phase 0~1 반영 완료
- 현재 FAIL 원인은 정책 위반(Phase 2)
=> 최소 재실행: Phase 2만 재실행

orchestrator:
- Phase 2 재시도 지시
- Dev 수정 후 재감사

---

# 6) Auditor 최종 검증 체크리스트(Phase 2.2-B)

Auditor는 아래를 최종 확인:

- [ ] CHANGE_IMPACT_REPORT.md 존재 및 내용 일관
- [ ] Phase 완료 시 Snapshot CREATED 존재
- [ ] FAIL 후 Snapshot RESTORED 존재
- [ ] RUN_LOG에 Gate/Impact/Rollback 이벤트 기록
- [ ] Plan Gate(Approval) 우회 불가 확인
- [ ] 최종 Audit PASS

---

# END OF Phase 2.2-B FULL VERIFICATION PACK
